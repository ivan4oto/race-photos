<section class="page">
  <div class="hero">
    <div class="hero-body">
      <p class="eyebrow">Admin • Events</p>
      <h1>Edit event</h1>
      <p class="lead">
        Update metadata, pricing, and assignments without leaving this workspace.
      </p>
      <div class="actions">
        <a routerLink="/admin/events" class="btn ghost">Back to events</a>
        <a routerLink="/admin/events/new" class="btn primary">Create new event</a>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="alert error" *ngIf="loadError()">{{ loadError() }}</div>
    <div class="loading" *ngIf="loadingEvent()">
      <div class="spinner"></div>
      <p>Loading event…</p>
    </div>

    <form *ngIf="!loadingEvent() && !loadError()" [formGroup]="form" (ngSubmit)="submit()" novalidate>
      <div class="alert success" *ngIf="submissionSuccess()">{{ submissionSuccess() }}</div>
      <div class="alert error" *ngIf="submissionError()">{{ submissionError() }}</div>

      <section class="card">
        <header>
          <h2>Core details</h2>
          <p>Identity, scheduling, and location details that power discovery.</p>
        </header>
        <div class="grid">
          <label>
            <span>Slug *</span>
            <input type="text" formControlName="slug" placeholder="e.g. berlin-marathon-2025" autocomplete="off">
            <small *ngIf="controlInvalid('slug')">Lowercase, dashes only; required.</small>
          </label>
          <label>
            <span>Name *</span>
            <input type="text" formControlName="name" placeholder="BMW Berlin Marathon 2025">
            <small *ngIf="controlInvalid('name')">Name is required.</small>
          </label>
          <label>
            <span>Status *</span>
            <select formControlName="status">
              <option *ngFor="let status of statuses" [value]="status">{{ status }}</option>
            </select>
          </label>
          <label>
            <span>Organizer</span>
            <select formControlName="organizerId">
              <option value="">No organizer</option>
              <option *ngFor="let organizer of organizers()" [value]="organizer.id">
                {{ organizer.slug }}
              </option>
            </select>
            <small *ngIf="organizerError()">{{ organizerError() }}</small>
          </label>
          <label>
            <span>Registration provider</span>
            <input type="text" formControlName="registrationProvider" placeholder="Race Roster, Njuko, etc.">
          </label>
          <label>
            <span>Timezone</span>
            <input type="text" formControlName="timezone" placeholder="Europe/Berlin">
          </label>
          <label>
            <span>Start time</span>
            <input type="datetime-local" formControlName="startTime">
          </label>
          <label>
            <span>End time</span>
            <input type="datetime-local" formControlName="endTime">
          </label>
          <label>
            <span>Location name</span>
            <input type="text" formControlName="locationName" placeholder="Tiergarten Start Village">
          </label>
          <label>
            <span>City</span>
            <input type="text" formControlName="locationCity" placeholder="Berlin">
          </label>
          <label>
            <span>State/Region</span>
            <input type="text" formControlName="locationState" placeholder="Berlin">
          </label>
          <label>
            <span>Country</span>
            <input type="text" formControlName="locationCountry" placeholder="Germany">
          </label>
          <label>
            <span>Cover image key</span>
            <input type="text" formControlName="coverImageKey" placeholder="media/events/berlin/cover.jpg">
          </label>
        </div>
        <label class="full">
          <span>Description</span>
          <textarea formControlName="description" rows="4" placeholder="Tell photographers and participants what makes this race special."></textarea>
        </label>
      </section>

      <section class="card">
        <header>
          <h2>Platform & ingestion</h2>
          <p>Wire the event into S3 + Rekognition, plus fine tune commerce knobs.</p>
        </header>
        <div class="grid">
          <label>
            <span>Vector collection ID</span>
            <input type="text" formControlName="vectorCollectionId" placeholder="rekognition-collection-id">
          </label>
          <label>
            <span>Upload prefix</span>
            <input type="text" formControlName="uploadPrefix" placeholder="in/events/berlin-2025/raw">
          </label>
          <label>
            <span>Platform commission</span>
            <input type="number" formControlName="platformCommissionRate" min="0" max="1" step="0.01" placeholder="0.25">
            <small>0.25 = 25% platform share</small>
          </label>
        </div>

        <div class="toggles">
          <label class="toggle">
            <input type="checkbox" formControlName="watermarkingEnabled">
            <span class="slider"></span>
            <div>
              <strong>Watermark previews</strong>
              <p>Enable watermarks for participant-facing galleries.</p>
            </div>
          </label>
          <label class="toggle">
            <input type="checkbox" formControlName="autoPublishMatches">
            <span class="slider"></span>
            <div>
              <strong>Auto publish matches</strong>
              <p>Skip manual review once Rekognition finds faces.</p>
            </div>
          </label>
        </div>

        <div class="subcard" formGroupName="defaultPricing">
          <div class="subcard-head">
            <h3>Default pricing</h3>
            <p>Reference rates used unless overridden at photo level.</p>
          </div>
          <div class="grid">
            <label>
              <span>Price per photo</span>
              <input type="number" formControlName="pricePerPhoto" min="0" step="0.01" placeholder="29.00">
            </label>
            <label>
              <span>Bundle price</span>
              <input type="number" formControlName="bundlePrice" min="0" step="0.01" placeholder="129.00">
            </label>
            <label>
              <span>Bundle size</span>
              <input type="number" formControlName="bundleSize" min="1" step="1" placeholder="10">
            </label>
            <label>
              <span>Currency</span>
              <input type="text" formControlName="currencyCode" maxlength="3" placeholder="EUR">
            </label>
          </div>
        </div>
      </section>

      <section class="card">
        <header>
          <h2>Access control</h2>
          <p>Define how we prove a participant is eligible for this gallery.</p>
        </header>
        <div class="grid" formGroupName="accessPolicy">
          <label>
            <span>Eligibility mode *</span>
            <select formControlName="mode">
              <option *ngFor="let mode of eligibilityModes" [value]="mode">{{ mode }}</option>
            </select>
          </label>
          <label>
            <span>Eligibility provider</span>
            <input type="text" formControlName="provider" placeholder="Roster import partner">
          </label>
        </div>
        <label class="full">
          <span>Eligibility configuration</span>
          <textarea formControlName="configuration" rows="4" placeholder="JSON, YAML, or notes on how to fetch roster data."></textarea>
        </label>
        <label class="full">
          <span>Participant message</span>
          <textarea formControlName="participantMessage" rows="3" placeholder="Copy surfaced on the gallery (deadlines, codes, etc.)."></textarea>
        </label>
      </section>

      <section class="card">
        <header>
          <h2>Photo assets</h2>
          <p>Track indexing progress and kick off face indexing for this event.</p>
        </header>

        <div class="photo-stats">
          <div class="stat">
            <p class="label">Indexed photos</p>
            <p class="value">{{ photoStats().indexed | number }}</p>
          </div>
          <div class="stat">
            <p class="label">Waiting to index</p>
            <p class="value">{{ photoStats().unindexed | number }}</p>
          </div>
        </div>

        <div class="indexing-actions">
          <button type="button" class="btn primary" (click)="indexFaces()" [disabled]="indexing() || !eventId">
            {{ indexing() ? 'Starting indexing…' : 'Index faces now' }}
          </button>
          <div class="alert success" *ngIf="indexingSuccess()">{{ indexingSuccess() }}</div>
          <div class="alert error" *ngIf="indexingError()">{{ indexingError() }}</div>
        </div>
      </section>

      <section class="card assignments">
        <header>
          <h2>Photographer assignments</h2>
          <p>Add or remove photographers linked to this event.</p>
        </header>

        <div class="assignment-grid">
          <div>
            <h3>Add photographer</h3>
            <p class="helper">Use slug, email, or first + last name.</p>
            <div class="assign-form" [formGroup]="assignmentForm">
              <label>
                <span>Slug</span>
                <input type="text" formControlName="slug" placeholder="photographer-slug">
              </label>
              <label>
                <span>Email</span>
                <input type="email" formControlName="email" placeholder="person@studio.com">
              </label>
              <div class="name-row">
                <label>
                  <span>First name</span>
                  <input type="text" formControlName="firstName">
                </label>
                <label>
                  <span>Last name</span>
                  <input type="text" formControlName="lastName">
                </label>
              </div>
              <div class="assign-actions">
                <button type="button" class="btn primary" (click)="assignPhotographer()" [disabled]="assigning()">
                  {{ assigning() ? 'Assigning…' : 'Add photographer' }}
                </button>
                <div class="alert error" *ngIf="assignmentError()">{{ assignmentError() }}</div>
              </div>
            </div>
          </div>

          <div>
            <h3>Assigned</h3>
            <p class="helper">Click remove to unassign.</p>
            <ul class="assigned-list" *ngIf="photographers().length > 0">
              <li *ngFor="let photographer of photographers()">
                <div>
                  <strong>{{ photographer.displayName }}</strong>
                  <small>{{ photographer.email }}</small>
                </div>
                <button type="button" class="link" (click)="removePhotographer(photographer)">Remove</button>
              </li>
            </ul>
            <p class="empty" *ngIf="photographers().length === 0">No photographers linked yet.</p>
          </div>
        </div>
      </section>

      <footer class="actions">
        <button type="submit" [disabled]="form.invalid || saving()">
          {{ saving() ? 'Saving…' : 'Save changes' }}
        </button>
        <p class="helper">Updates the event immediately.</p>
      </footer>
    </form>
  </div>
</section>
